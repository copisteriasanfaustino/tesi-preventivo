<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Modulo Preventivo Tesi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; background: #fffaf3; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, select { padding: 0.5em; width: 100%; max-width: 400px; margin-top: 5px; }
    button { padding: 0.7em 1.2em; background: #a84300; color: white; border: none; border-radius: 4px; margin-top: 1.5em; cursor: pointer; }
    #preview { margin-top: 1em; max-width: 250px; display: none; border: 1px solid #ccc; }
    #progress { margin-top: 1em; height: 10px; background: #ddd; width: 100%; max-width: 400px; border-radius: 4px; overflow: hidden; }
    #bar { height: 100%; width: 0%; background: #a84300; transition: width 0.2s; }
    #result { margin-top: 2em; background: #fff3e6; padding: 1em; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Preventivo Tesi Stampata a Caldo</h2>

  <label for="pdf">ğŸ“„ Carica PDF:</label>
  <input type="file" id="pdf" accept="application/pdf" />

  <label for="copie">ğŸ“¦ Numero copie:</label>
  <input type="number" id="copie" value="1" min="1" />

  <label for="stampa">ğŸ–¨ï¸ Tipo di stampa:</label>
  <select id="stampa">
    <option value="0.03">Solo fronte (+â‚¬0,03/pagina)</option>
    <option value="0">Fronte-retro</option>
  </select>

  <label for="copertina">ğŸ¨ Colore copertina:</label>
  <select id="copertina">
    <option value="">-- Seleziona --</option>
    <option value="panama_azzurro">Panama Azzurro</option>
    <option value="panama_bianco">Panama Bianco</option>
    <option value="panama_celeste">Panama Celeste</option>
    <option value="panama_laguna">Panama Laguna</option>
    <option value="panama_lavanda">Panama Lavanda</option>
    <option value="panama_malva">Panama Malva</option>
    <option value="panama_rosa">Panama Rosa</option>
    <option value="panama_rosa_antico">Panama Rosa Antico</option>
    <option value="panama_turchese">Panama Turchese</option>
    <option value="panama_viola">Panama Viola</option>
    <option value="perla_arancio">Perla Arancio</option>
    <option value="perla_avorio">Perla Avorio</option>
    <option value="perla_blu">Perla Blu</option>
    <option value="perla_bordeaux">Perla Bordeaux</option>
    <option value="perla_giallo">Perla Giallo</option>
    <option value="perla_grigio">Perla Grigio</option>
    <option value="perla_navy">Perla Navy</option>
    <option value="perla_nocciola">Perla Nocciola</option>
    <option value="perla_rosso">Perla Rosso</option>
    <option value="perla_verde">Perla Verde</option>
    <option value="venus_avio">Venus Avio</option>
    <option value="venus_blu">Venus Blu</option>
    <option value="venus_blu_elettrico">Venus Blu Elettrico</option>
    <option value="venus_bordeaux">Venus Bordeaux</option>
    <option value="venus_ciclamino">Venus Ciclamino</option>
    <option value="venus_cipria">Venus Cipria</option>
    <option value="venus_denim">Venus Denim</option>
    <option value="venus_fucsia">Venus Fucsia</option>
    <option value="venus_grigio">Venus Grigio</option>
    <option value="venus_lilla">Venus Lilla</option>
    <option value="venus_lime">Venus Lime</option>
    <option value="venus_nero">Venus Nero</option>
    <option value="venus_rosso">Venus Rosso</option>
    <option value="venus_sabbia">Venus Sabbia</option>
    <option value="venus_tiffany">Venus Tiffany</option>
    <option value="venus_verde">Venus Verde</option>
  </select>

  <img id="preview" src="" alt="Copertina selezionata">

  <button id="calcola">Calcola Preventivo</button>

  <div id="progress"><div id="bar"></div></div>

  <div id="result"></div>

  <script>
    const copertinaSelect = document.getElementById("copertina");
    const preview = document.getElementById("preview");

    copertinaSelect.addEventListener("change", () => {
      const val = copertinaSelect.value;
      if (val) {
        preview.src = val + ".png";
        preview.alt = copertinaSelect.options[copertinaSelect.selectedIndex].text;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    });

    document.getElementById("calcola").onclick = async () => {
      const file = document.getElementById("pdf").files[0];
      if (!file) return alert("Carica un file PDF.");

      const copie = +document.getElementById("copie").value || 1;
      const extra = +document.getElementById("stampa").value;

      const reader = new FileReader();
      reader.onload = async () => {
        const buffer = reader.result;
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

        let bn = 0, col = 0;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const vp = page.getViewport({ scale: 1 });
          const cv = document.createElement("canvas");
          cv.width = vp.width; cv.height = vp.height;
          await page.render({ canvasContext: cv.getContext("2d"), viewport: vp }).promise;
          const img = cv.getContext("2d").getImageData(0,0,cv.width,cv.height).data;

          let isColor = false;
          for (let p = 0; p < img.length; p += 4) {
            if (img[p] !== img[p+1] || img[p+1] !== img[p+2]) {
              isColor = true; break;
            }
          }
          isColor ? col++ : bn++;
          document.getElementById("bar").style.width = Math.round((i/pdf.numPages)*100) + "%";
        }

        const base = 20 * copie;
        const costBN = bn * (0.07 + extra) * copie;
        const costCol = col * (0.50 + extra) * copie;
        const totale = base + costBN + costCol;
        const perCopia = totale / copie;

        document.getElementById("result").innerHTML = `
          <h3>Riepilogo Preventivo</h3>
          <p>ğŸ“„ Pagine B/N: ${bn}</p>
          <p>ğŸ¨ Pagine colore: ${col}</p>
          <p>ğŸ“¦ Copie: ${copie}</p>
          <p>ğŸ–¨ï¸ Tipo stampa: ${extra > 0 ? "Solo fronte" : "Fronte-retro"}</p>
          <p>ğŸ¨ Copertina: ${copertinaSelect.options[copertinaSelect.selectedIndex].text || "â€”"}</p>
          <p>ğŸ’° Totale: <strong>â‚¬${totale.toFixed(2)}</strong></p>
          <p>ğŸ“Š Prezzo per copia:
          <!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Preventivo Tesi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; background: #fffaf3; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, select { padding: 0.5em; width: 100%; max-width: 400px; margin-top: 5px; }
    button { padding: 0.7em 1.2em; background: #a84300; color: white; border: none; border-radius: 4px; margin-top: 1.5em; cursor: pointer; }
    #preview { margin-top: 1em; max-width: 250px; display: none; border: 1px solid #ccc; }
    #progress { margin-top: 1em; height: 10px; background: #ddd; width: 100%; max-width: 400px; border-radius: 4px; overflow: hidden; }
    #bar { height: 100%; width: 0%; background: #a84300; transition: width 0.2s; }
    #result { margin-top: 2em; background: #fff3e6; padding: 1em; border-radius: 6px; }
    option { background-repeat: no-repeat; background-position: 5px center; background-size: 24px 24px; padding-left: 32px; }
  </style>
</head>
<body>
  <h2>Preventivo Tesi Stampata a Caldo</h2>

  <label for="pdf">ğŸ“„ Carica PDF:</label>
  <input type="file" id="pdf" accept="application/pdf" />

  <label for="copie">ğŸ“¦ Numero copie:</label>
  <input type="number" id="copie" value="1" min="1" />

  <label for="stampa">ğŸ–¨ï¸ Tipo di stampa:</label>
  <select id="stampa">
    <option value="0.03">Solo fronte (+â‚¬0,03/pagina)</option>
    <option value="0">Fronte-retro</option>
  </select>

  <label for="copertina">ğŸ¨ Colore copertina:</label>
  <select id="copertina">
    <option value="">-- Seleziona --</option>
    <option style="background-image: url('panama_azzurro.png')" value="panama_azzurro">Panama Azzurro</option>
    <option style="background-image: url('panama_bianco.png')" value="panama_bianco">Panama Bianco</option>
    <!-- aggiungi qui tutte le altre copertine con miniature -->
  </select>

  <img id="preview" src="" alt="Copertina selezionata">
  <button id="calcola">Calcola Preventivo</button>
  <div id="progress"><div id="bar"></div></div>
  <div id="result"></div>
