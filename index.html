<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Preventivo e ordine Tesi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
    input, select, button { width: 100%; padding: 8px; box-sizing: border-box;
      border: 1px solid #ccc; border-radius: 4px; }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #0056b3; }

    #coverGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .cover-item {
      width: 100px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 4px;
      overflow: hidden;
      transition: border-color .2s;
    }
    .cover-item.selected { border-color: #007bff; }
    .cover-item img { width: 100%; display: block; }

    #coverLargePreview {
      max-width: 200px;
      margin-top: 10px;
      display: none;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #coverName { margin-top: 5px; font-weight: bold; }

    progress {
      width: 100%;
      height: 16px;
      display: none;
      margin-top: 5px;
    }
    #pageInfo { display: none; margin-top: 5px; }

    .payment-methods {
      display: flex;
      gap: 20px;
      margin-top: 5px;
    }
    .payment-methods label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .payment-methods input[disabled] + span {
      color: #999;
      cursor: not-allowed;
    }

    #orderForm { display: none; margin-top: 20px; padding-top: 20px;
      border-top: 1px solid #ddd; }
    #addressFields { display: none; }

    #quoteResult, #finalTotal {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      color: #333;
    }

    #thankYou {
      display: none;
      margin-top: 30px;
      font-size: 20px;
      color: green;
      text-align: center;
    }
  </style>
  <!-- PDF.js per contare e renderizzare le pagine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <!-- EmailJS SDK -->
  <script type="text/javascript"
    src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
  <script>
    emailjs.init('YOUR_EMAILJS_USER_ID'); // sostituisci con il tuo user ID EmailJS
  </script>
</head>
<body>
  <div class="container">
    <h1>Preventivo Stampa PDF</h1>

    <!-- 1. Numero copie -->
    <div class="form-group">
      <label for="copies">üìÑ Numero di copie:</label>
      <input type="number" id="copies" min="1" value="1" />
    </div>

    <!-- 2. Upload PDF -->
    <div class="form-group">
      <label for="pdfFile">üìÇ Carica il tuo PDF:</label>
      <input type="file" id="pdfFile" accept="application/pdf" />
      <progress id="loadProgress" max="100" value="0"></progress>
      <p id="pageInfo">
        Pagine: <span id="pageCount">0</span>,
        B/N: <span id="bwCount">0</span>,
        Colori: <span id="colorCount">0</span>
      </p>
    </div>

    <!-- 3. Griglia copertine -->
    <div class="form-group">
      <label>üé® Scegli una copertina:</label>
      <div id="coverGrid">Caricamento‚Ä¶</div>
      <img id="coverLargePreview" alt="Anteprima copertina" />
      <p id="coverName"></p>
    </div>

    <!-- 4. Finitura copertina -->
    <div class="form-group">
      <label for="coverFinish">üîñ Finitura copertina:</label>
      <select id="coverFinish">
        <option value="oro">Oro</option>
        <option value="argento">Argento</option>
        <option value="bronzo">Bronzo</option>
      </select>
    </div>

    <!-- 5. Tipo di stampa -->
    <div class="form-group">
      <label for="printType">üîÅ Tipo di stampa:</label>
      <select id="printType">
        <option value="duplex">Fronte-retro (B/N ‚Ç¨0,07 ‚Äì Colore ‚Ç¨0,50)</option>
        <option value="front">Solo fronte (+‚Ç¨0,03/faccia)</option>
      </select>
    </div>

    <!-- 6. Calcola preventivo -->
    <button id="calcBtn">üßÆ Calcola preventivo</button>
    <p id="quoteResult">üí∂ Preventivo: ‚Ç¨0.00</p>

    <!-- 7. Invia ordine -->
    <button id="orderBtn" style="display:none;">‚úâÔ∏è Compila dati e conferma</button>

    <!-- 8. Form d‚Äôordine -->
    <div id="orderForm">
      <h2>Dettagli Cliente</h2>
      <div class="form-group">
        <label for="firstName">Nome:</label>
        <input id="firstName" type="text" />
      </div>
      <div class="form-group">
        <label for="lastName">Cognome:</label>
        <input id="lastName" type="text" />
      </div>
      <div class="form-group">
        <label for="phone">Telefono:</label>
        <input id="phone" type="tel" />
      </div>
      <div class="form-group">
        <label for="email">Email:</label>
        <input id="email" type="email" />
      </div>

      <h2>Consegna e Pagamento</h2>
      <div class="form-group">
        <label for="shippingMethod">Modalit√† di ritiro/consegna:</label>
        <select id="shippingMethod">
          <option value="pickup">Ritiro in negozio (gratis)</option>
          <option value="delivery">Consegna a domicilio (+‚Ç¨10)</option>
        </select>
      </div>

      <div id="addressFields">
        <div class="form-group">
          <label for="street">Via:</label>
          <input id="street" type="text" />
        </div>
        <div class="form-group">
          <label for="civic">Numero civico:</label>
          <input id="civic" type="text" />
        </div>
        <div class="form-group">
          <label for="zip">CAP:</label>
          <input id="zip" type="text" />
        </div>
        <div class="form-group">
          <label for="city">Citt√†:</label>
          <input id="city" type="text" />
        </div>
      </div>

      <div class="form-group">
        <label>Metodo di pagamento:</label>
        <div class="payment-methods">
          <label>
            <input type="radio" name="pay" id="paypal" value="PayPal" />
            <span>PayPal</span>
          </label>
          <label>
            <input type="radio" name="pay" id="bank" value="Bonifico" />
            <span>Bonifico</span>
          </label>
          <label>
            <input type="radio" name="pay" id="cod" value="Alla consegna" />
            <span>Alla consegna</span>
          </label>
        </div>
      </div>

      <p id="finalTotal">Totale con spedizione: ‚Ç¨0.00</p>
      <button id="submitOrder">üì§ Conferma ordine</button>
    </div>

    <p id="thankYou">Ordine ricevuto, invieremo conferma quanto prima, grazie!</p>
  </div>

  <script>
    let selectedCoverUrl = '';
    let baseTotal = 0;
    let pdfFile = null; // riferimento al file caricato

    document.addEventListener('DOMContentLoaded', () => {
      loadCovers();
      document.getElementById('pdfFile').addEventListener('change', e => {
        pdfFile = e.target.files[0];
        handlePdf(e);
      });
      document.getElementById('calcBtn').addEventListener('click', calcQuote);
      document.getElementById('orderBtn').addEventListener('click', () => {
        document.getElementById('orderForm').style.display = 'block';
        updateFinalTotal();
      });
      document.getElementById('shippingMethod')
        .addEventListener('change', toggleAddressAndTotal);
    });

    // Carica copertine
    async function loadCovers() {
      const apiUrl = 'https://api.github.com/repos/copisteriasanfaustino/tesi-preventivo/contents';
      const grid = document.getElementById('coverGrid');
      grid.innerHTML = '';
      try {
        const res = await fetch(apiUrl);
        const files = await res.json();
        files.filter(f => /\.(jpe?g|png)$/i.test(f.name))
          .forEach(f => {
            const div = document.createElement('div');
            div.className = 'cover-item';
            const img = document.createElement('img');
            img.src = f.download_url;
            img.alt = f.name;
            div.appendChild(img);
            div.addEventListener('click', () => {
              document.querySelectorAll('.cover-item')
                .forEach(i=>i.classList.remove('selected'));
              div.classList.add('selected');
              selectedCoverUrl = f.download_url;
              document.getElementById('coverLargePreview').src = f.download_url;
              document.getElementById('coverLargePreview').style.display = 'block';
              document.getElementById('coverName').innerText =
                f.name.replace(/\.(jpe?g|png)$/i,'');
            });
            grid.appendChild(div);
          });
      } catch(e){
        grid.innerText = 'Errore caricamento copertine';
      }
    }

    // Conteggio pagine B/N vs colore
    async function handlePdf(e) {
      const file = pdfFile;
      if (!file) return;
      const reader = new FileReader();
      const prog = document.getElementById('loadProgress');
      const info = document.getElementById('pageInfo');
      prog.style.display = 'block';
      info.style.display = 'none';

      reader.onload = async () => {
        const pdf = await pdfjsLib.getDocument({ data: reader.result }).promise;
        let colorCount = 0;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const vp = page.getViewport({ scale: 0.2 });
          const cnv = document.createElement('canvas');
          const ctx = cnv.getContext('2d');
          cnv.width = vp.width; cnv.height = vp.height;
          await page.render({ canvasContext: ctx, viewport: vp }).promise;
          const d = ctx.getImageData(0,0,cnv.width,cnv.height).data;
          let isColor=false;
          for (let j=0; j<d.length; j+=4*20) {
            if (Math.abs(d[j]-d[j+1])>15 ||
                Math.abs(d[j]-d[j+2])>15 ||
                Math.abs(d[j+1]-d[j+2])>15) {
              isColor=true; break;
            }
          }
          if(isColor) colorCount++;
          prog.value = Math.round(i/pdf.numPages*100);
        }
        document.getElementById('pageCount').innerText  = pdf.numPages;
        document.getElementById('colorCount').innerText = colorCount;
        document.getElementById('bwCount').innerText    = pdf.numPages - colorCount;
        prog.style.display = 'none';
        info.style.display = 'block';
      };
      reader.readAsArrayBuffer(file);
    }

    // Calcola preventivo
    function calcQuote() {
      const copies   = +document.getElementById('copies').value;
      const bw       = +document.getElementById('bwCount').innerText;
      const col      = +document.getElementById('colorCount').innerText;
      const type     = document.getElementById('printType').value;
      const rateBn   = 0.07;
      const rateCol  = 0.50;
      const supFront = 0.03;
      const coverCost= 20;
      let bnCost = rateBn, colCost = rateCol;
      if (type === 'front') {
        bnCost += supFront;
        colCost += supFront;
      }
      const perCopy = bnCost*bw + colCost*col + coverCost;
      baseTotal = perCopy * copies;
      document.getElementById('quoteResult').innerText =
        `üí∂ Preventivo: ‚Ç¨${baseTotal.toFixed(2)}`;
      document.getElementById('orderBtn').style.display = 'block';
    }

    // Gestisci consegna e COD
    function toggleAddressAndTotal() {
      const method = document.getElementById('shippingMethod').value;
      document.getElementById('addressFields').style.display =
        method === 'delivery' ? 'block' : 'none';
      const codInp = document.getElementById('cod');
      codInp.disabled = method === 'delivery';
      if (codInp.disabled && codInp.checked) codInp.checked = false;
      updateFinalTotal();
    }

    // Totale con spedizione
    function updateFinalTotal() {
      const ship = document.getElementById('shippingMethod').value === 'delivery' ? 10 : 0;
      document.getElementById('finalTotal').innerText =
        `Totale con spedizione: ‚Ç¨${(baseTotal + ship).toFixed(2)}`;
    }

    // Invia email con EmailJS e mostra messaggio di conferma
    document.getElementById('submitOrder').addEventListener('click', async e => {
      e.preventDefault();
      // Leggi PDF come base64
      const file = pdfFile;
      const reader = new FileReader();
      reader.onload = async () => {
        const pdfBase64 = reader.result.split(',')[1]; // rimuove data:...;base64,
        // Prepara parametri
        const params = {
          to_email:    'info@sgesanfaustino.it',
          nome:        document.getElementById('firstName').value,
          cognome:     document.getElementById('lastName').value,
          telefono:    document.getElementById('phone').value,
          email_cliente: document.getElementById('email').value,
          shipping:    document.getElementById('shippingMethod').value === 'delivery'
                       ? `Consegna (+‚Ç¨10) - ${document.getElementById('street').value}, ` +
                         `${document.getElementById('civic').value}, ` +
                         `${document.getElementById('zip').value} ` +
                         `${document.getElementById('city').value}`
                       : 'Ritiro in negozio',
          pagamento:   document.querySelector('input[name=pay]:checked').value,
          copie:       document.getElementById('copies').value,
          pagine_tot:  document.getElementById('pageCount').innerText,
          bn:          document.getElementById('bwCount').innerText,
          colori:      document.getElementById('colorCount').innerText,
          cover:       document.getElementById('coverName').innerText + ' (' +
                       document.getElementById('coverFinish').value + ')',
          preventivo:  document.getElementById('quoteResult').innerText.replace('üí∂ ',''),
          totale_finale: document.getElementById('finalTotal').innerText.replace('Totale con spedizione: ',''),
          attachment:  {
            name: file.name,
            data: pdfBase64
          }
        };

        try {
          await emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', params);
          document.getElementById('orderForm').style.display = 'none';
          document.getElementById('thankYou').style.display = 'block';
        } catch(err) {
          alert('Errore invio ordine. Riprova pi√π tardi.');
          console.error(err);
        }
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
